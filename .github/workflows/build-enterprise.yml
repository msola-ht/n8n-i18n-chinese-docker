name: æ„å»º n8n ä¸­æ–‡ä¼ä¸šç‰ˆ Docker é•œåƒ

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '30 * * * *'  # æ¯å°æ—¶ç¬¬30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œé¿å…ä¸åŸºç¡€æ„å»ºå†²çª

env:
  UPSTREAM_REPO: other-blowsnow/n8n-i18n-chinese # ä¸Šæ¸¸ä»“åº“åœ°å€

jobs:
  build-and-push-enterprise:
    runs-on: ubuntu-latest # åœ¨ Ubuntu æœ€æ–°ç‰ˆç³»ç»Ÿä¸Šè¿è¡Œ

    steps:
    - name: æ‹‰å–å½“å‰ä»“åº“ä»£ç  # æ­¥éª¤1: æ‹‰å–å½“å‰ä»“åº“ä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼ŒåŒ…æ‹¬æ ‡ç­¾ï¼Œä»¥ä¾¿æ£€æŸ¥

    - name: è·å–ä¸Šæ¸¸æœ€æ–°å‘å¸ƒä¿¡æ¯ # æ­¥éª¤2: ä»ä¸Šæ¸¸ä»“åº“è·å–æœ€æ–°å‘å¸ƒä¿¡æ¯
      id: get_release
      run: |
        latest_release=$(curl -s https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest)
        # ä½¿ç”¨ xargs ç¡®ä¿å»é™¤æ‰€æœ‰å‰å¯¼å’Œå°¾éƒ¨ç©ºæ ¼
        tag=$(echo "$latest_release" | jq -r .tag_name | xargs) # è·å–ä¸Šæ¸¸çš„ Git Tagï¼Œä¾‹å¦‚ n8n@1.115.3
        asset_url=$(echo "$latest_release" | jq -r '.assets[] | select(.name|endswith(".tar.gz")) | .browser_download_url' | xargs) # è·å–ä¸‹è½½é“¾æ¥
        echo "tag=$tag" >> "$GITHUB_OUTPUT" # å°†tagè®¾ç½®ä¸ºè¾“å‡º
        echo "asset_url=$asset_url" >> "$GITHUB_OUTPUT" # å°†ä¸‹è½½é“¾æ¥è®¾ç½®ä¸ºè¾“å‡º
        echo "æ£€æµ‹åˆ°ä¸Šæ¸¸æ ‡ç­¾: '$tag'" # æ‰“å°å¸¦å¼•å·çš„tagï¼Œæ–¹ä¾¿è°ƒè¯•ç©ºæ ¼

    - name: æ£€æŸ¥æ­¤ç‰ˆæœ¬æ˜¯å¦å·²å‘å¸ƒ # æ–°å¢æ­¥éª¤ï¼šæ£€æŸ¥å½“å‰ä»“åº“æ˜¯å¦å·²å­˜åœ¨ä¸ä¸Šæ¸¸æœ€æ–° release ç›¸åŒçš„ Git Tag
      id: check_tag
      run: |
        UPSTREAM_TAG="${{ steps.get_release.outputs.tag }}"
        ENTERPRISE_TAG="${UPSTREAM_TAG}-enterprise" # ä¼ä¸šç‰ˆæ ‡ç­¾åç¼€
        echo "æ­£åœ¨æ£€æŸ¥å½“å‰ä»“åº“æ˜¯å¦å·²å­˜åœ¨ä¼ä¸šç‰ˆ Git Tag: '$ENTERPRISE_TAG'"
        # ä½¿ç”¨ git ls-remote æ£€æŸ¥è¿œç¨‹ä»“åº“ï¼ˆoriginï¼‰ä¸­æ˜¯å¦å­˜åœ¨è¯¥æ ‡ç­¾
        # grep -q ç”¨äºé™é»˜è¾“å‡ºï¼Œåªè¿”å›é€€å‡ºçŠ¶æ€ç 
        if git ls-remote --tags origin | grep -q "refs/tags/$ENTERPRISE_TAG$"; then
          echo "æ£€æµ‹åˆ°ä¼ä¸šç‰ˆæ ‡ç­¾ '$ENTERPRISE_TAG' å·²å­˜åœ¨äºå½“å‰ä»“åº“ï¼Œæ­¤ç‰ˆæœ¬å·²å‘å¸ƒè¿‡ã€‚"
          echo "exists=true" >> "$GITHUB_OUTPUT"
        else
          echo "ä¼ä¸šç‰ˆæ ‡ç­¾ '$ENTERPRISE_TAG' ä¸å­˜åœ¨äºå½“å‰ä»“åº“ï¼Œå°†ç»§ç»­æ„å»ºæ–°ç‰ˆæœ¬ã€‚"
          echo "exists=false" >> "$GITHUB_OUTPUT"
        fi

    - name: æç¤ºï¼šæ­¤ç‰ˆæœ¬å·²å‘å¸ƒï¼Œå°†è·³è¿‡åç»­æ„å»ºæ­¥éª¤
      if: steps.check_tag.outputs.exists == 'true' # åªæœ‰å½“å·²å‘å¸ƒæ—¶æ‰æ‰§è¡Œæ­¤æç¤º
      run: |
        echo "æ£€æµ‹åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬å·²åœ¨å½“å‰ä»“åº“å‘å¸ƒè¿‡ä¼ä¸šç‰ˆï¼Œæ— éœ€é‡å¤æ„å»ºå’Œæ¨é€ã€‚åç»­æ„å»ºæ­¥éª¤å°†è¢«è·³è¿‡ã€‚"

    # ä»¥ä¸‹æ‰€æœ‰æ­¥éª¤éƒ½æ·»åŠ äº† if æ¡ä»¶ï¼Œåªæœ‰åœ¨ç‰ˆæœ¬æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
    - name: ä»æ ‡ç­¾ä¸­æå– n8n ç‰ˆæœ¬å· # æ­¥éª¤3: ä»ä¸Šæ¸¸Gitæ ‡ç­¾ä¸­æå–çº¯ç²¹çš„n8nç‰ˆæœ¬å·
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      id: get_n8n_version
      run: |
        TAG_REF="${{ steps.get_release.outputs.tag }}"
        # æå–åå†æ¬¡ä½¿ç”¨ xargs ç¡®ä¿å»é™¤æ‰€æœ‰å‰å¯¼å’Œå°¾éƒ¨ç©ºæ ¼
        N8N_VERSION=$(echo "${TAG_REF#n8n@}" | xargs) # æå–å‡º '1.115.3'
        echo "n8n_version=$N8N_VERSION" >> "$GITHUB_OUTPUT" # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºè¾“å‡º
        echo "æå–åˆ°çš„ n8n ç‰ˆæœ¬å·: '$N8N_VERSION'" # æ‰“å°å¸¦å¼•å·çš„ç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿è°ƒè¯•ç©ºæ ¼

    - name: è°ƒè¯• Docker Hub ç”¨æˆ·å # æ­¥éª¤4: æ£€æŸ¥ DOCKERHUB_USERNAME æ˜¯å¦æœ‰ç©ºæ ¼ï¼Œå¹¶æ¸…ç†
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        DOCKERHUB_USERNAME_VAL="${{ secrets.DOCKERHUB_USERNAME }}"
        echo "--- è°ƒè¯• Docker Hub ç”¨æˆ·å ---"
        echo "ç”¨æˆ·å (å¸¦å¼•å·): '$DOCKERHUB_USERNAME_VAL'"
        echo "ç”¨æˆ·åé•¿åº¦: ${#DOCKERHUB_USERNAME_VAL}"
        echo "------------------------------------"
        # å¢åŠ ä¸€ä¸ªé˜²å¾¡æ€§å¤„ç†ï¼Œç¡®ä¿ DOCKERHUB_USERNAME ä¸åŒ…å«ç©ºæ ¼ï¼Œå¹¶è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
        CLEAN_DOCKERHUB_USERNAME=$(echo "$DOCKERHUB_USERNAME_VAL" | xargs)
        echo "æ¸…ç†åçš„ç”¨æˆ·å (å¸¦å¼•å·): '$CLEAN_DOCKERHUB_USERNAME'"
        echo "æ¸…ç†åçš„ç”¨æˆ·åé•¿åº¦: ${#CLEAN_DOCKERHUB_USERNAME}"
        echo "DOCKERHUB_USERNAME=$CLEAN_DOCKERHUB_USERNAME" >> "$GITHUB_ENV" # å°†æ¸…ç†åçš„ç”¨æˆ·åè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨

    - name: ä¸‹è½½ä¸Šæ¸¸å‘å¸ƒæ–‡ä»¶ # æ­¥éª¤5: ä¸‹è½½ä¸Šæ¸¸çš„ editor-ui dist æ–‡ä»¶
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        mkdir -p src-dist
        curl -L "${{ steps.get_release.outputs.asset_url }}" -o src-dist/editor-ui.tar.gz
        echo "å·²ä¸‹è½½ ${{ steps.get_release.outputs.asset_url }}"

    - name: è§£å‹ dist æ–‡ä»¶ # æ­¥éª¤6: è§£å‹ä¸‹è½½çš„ tar.gz æ–‡ä»¶
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        tar -xzvf src-dist/editor-ui.tar.gz -C src-dist
        echo "å·²è§£å‹ dist æ–‡ä»¶åˆ° src-dist/dist"

    - name: ç”Ÿæˆä¼ä¸šç‰ˆ Dockerfile (å¤šé˜¶æ®µæ„å»º) # æ­¥éª¤7: åŠ¨æ€ç”ŸæˆåŒ…å«ä¼ä¸šç‰ˆåŠŸèƒ½æ¨¡æ‹Ÿçš„ Dockerfile
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        N8N_VERSION=${{ steps.get_n8n_version.outputs.n8n_version }} # ä½¿ç”¨æå–å‡ºçš„çº¯ç²¹ç‰ˆæœ¬å·
        echo "æ­£åœ¨ä¸º n8n ä¼ä¸šç‰ˆç‰ˆæœ¬: $N8N_VERSION ç”Ÿæˆå¤šé˜¶æ®µ Dockerfile"

        # åˆ›å»ºä¼ä¸šç‰ˆ Dockerfile
        cat > Dockerfile.enterprise <<DOCKERFILE
        # --- é˜¶æ®µ 1: ui_holder (ç”¨äºä»æ„å»ºä¸Šä¸‹æ–‡å¤åˆ¶ dist æ–‡ä»¶) ---
        FROM alpine:latest as ui_holder
        WORKDIR /app
        # å°† GitHub Actions Runner ä¸Šå·²å­˜åœ¨çš„ src-dist/dist ç›®å½•å¤åˆ¶åˆ°è¿™ä¸€é˜¶æ®µçš„é•œåƒä¸­
        COPY src-dist/dist /app/dist

        # --- é˜¶æ®µ 2: Final n8n Enterprise Image (æœ€ç»ˆä¼ä¸šç‰ˆé•œåƒ) ---
        FROM n8nio/n8n:\${N8N_VERSION}
        USER root

        RUN apk update && \\
            apk add --no-cache ffmpeg && \\
            rm -rf /var/cache/apk/*

        USER node

        # ä» ui_holder é˜¶æ®µå¤åˆ¶çº¯å‡€çš„ dist æ–‡ä»¶åˆ° n8n çš„ editor-ui ç›®å½•
        COPY --from=ui_holder /app/dist /usr/local/lib/node_modules/n8n/node_modules/n8n-editor-ui/dist

        # æ·»åŠ ä¼ä¸šç‰ˆåŠŸèƒ½æ¨¡æ‹Ÿ
        ENV TARGET_FILE=/usr/local/lib/node_modules/n8n/dist/commands/base-command.js

        RUN set -e && \\
            cat > /tmp/enterprise-mock.js <<'EOT' && \\
        const originalInit = BaseCommand.prototype.init;
        const originalInitLicense = BaseCommand.prototype.initLicense;

        function initEnterpriseMock() {
            const Container = require("@n8n/di").Container;
            const License = require("../license").License;
            const constants = require("@n8n/constants");
            const LICENSE_QUOTAS = constants.LICENSE_QUOTAS;
            const LICENSE_FEATURES = constants.LICENSE_FEATURES;
            const UNLIMITED_LICENSE_QUOTA = constants.UNLIMITED_LICENSE_QUOTA;

            try {
                const license = Container.get(License);
                if (!license) {
                    console.warn("[ENTERPRISE MOCK] License service not available");
                    return;
                }

                const originalIsLicensed = license.isLicensed.bind(license);
                const origialGetValue = license.getValue.bind(license);

                license.isLicensed = function(feature) {
                    if (feature === "feat:showNonProdBanner") {
                        return false;
                    }
                    return true;
                };

                license.getValue = function(feature) {
                    if (feature === "planName") {
                        return "Enterprise (Mocked)";
                    }
                    if (Object.values(LICENSE_QUOTAS).includes(feature)) {
                        console.log("[ENTERPRISE MOCK] Quota " + feature + " set to unlimited");
                        return UNLIMITED_LICENSE_QUOTA;
                    }
                    if (Object.values(LICENSE_FEATURES).includes(feature)) {
                        console.log("[ENTERPRISE MOCK] Feature " + feature + " enabled");
                        return true;
                    }
                    return origialGetValue(feature);
                };

                [
                    "isAdvancedPermissionsLicensed", "isSharingEnabled", "isLdapEnabled",
                    "isSamlEnabled", "isSourceControlLicensed", "isVariablesEnabled",
                    "isExternalSecretsEnabled", "isWorkflowHistoryLicensed", "isLogStreamingEnabled",
                    "isMultiMainLicensed", "isBinaryDataS3Licensed", "isDebugInEditorLicensed",
                    "isWorkerViewLicensed", "isAiCreditsEnabled", "isFoldersEnabled",
                    "isProjectRoleAdminLicensed", "isProjectRoleEditorLicensed", "isProjectRoleViewerLicensed",
                    "isCustomNpmRegistryEnabled", "isWithinUsersLimit"
                ].forEach(function(key) { license[key] = function() { return true; }; });

                [
                    "getUsersLimit", "getTriggerLimit", "getVariablesLimit",
                    "getWorkflowHistoryPruneLimit", "getTeamProjectLimit"
                ].forEach(function(key) { license[key] = function() { return UNLIMITED_LICENSE_QUOTA; }; });

                license.isAPIDisabled = function() { return false; };
                license.isAiAssistantEnabled = function() { return false; };
                license.getAiCredits = function() { return 999999; };
                license.getPlanName = function() { return "Enterprise (Mocked)"; };
                license.getConsumerId = function() { return "enterprise-mock-consumer"; };
                license.getManagementJwt = function() { return "mock-jwt-token"; };

                console.log("[ENTERPRISE MOCK] All enterprise features enabled");
            } catch (error) {
                console.error("[ENTERPRISE MOCK] Failed to enable enterprise mock:", error);
            }
        }

        BaseCommand.prototype.init = async function() {
            await originalInit.call(this);
            await this.initLicense();
        };

        BaseCommand.prototype.initLicense = async function() {
            await originalInitLicense.call(this);
            initEnterpriseMock();
        };
        EOT
            sed '/^exports\.BaseCommand = BaseCommand;$/r /tmp/enterprise-mock.js' "\${TARGET_FILE}" > "\${TARGET_FILE}.tmp" && \\
            mv "\${TARGET_FILE}.tmp" "\${TARGET_FILE}" && \\
            rm /tmp/enterprise-mock.js
        DOCKERFILE

        # æ›¿æ¢ N8N_VERSION å˜é‡
        sed -i 's/\${N8N_VERSION}/'"$N8N_VERSION"'/g' Dockerfile.enterprise

        cat Dockerfile.enterprise # æ‰“å°ç”Ÿæˆçš„ Dockerfile å†…å®¹ä»¥ä¾›è°ƒè¯•

    - name: è®¾ç½® Docker Buildx # æ­¥éª¤8: è®¾ç½®Docker Buildxï¼Œç”¨äºæ›´é«˜æ•ˆå’Œå®‰å…¨çš„æ„å»º
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ° Docker Hub # æ­¥éª¤9: ç™»å½•åˆ°Docker Hub
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: è°ƒè¯•æœ€ç»ˆé•œåƒæ ‡ç­¾ # æ­¥éª¤10: æ‰“å°æœ€ç»ˆçš„æ ‡ç­¾å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿è°ƒè¯•
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        # ä½¿ç”¨é€šè¿‡ $GITHUB_ENV è®¾ç½®çš„æ¸…ç†åçš„ DOCKERHUB_USERNAME
        echo "--- è°ƒè¯•ä¼ä¸šç‰ˆé•œåƒæ ‡ç­¾ ---"
        echo "ç‰ˆæœ¬æ ‡ç­¾: '${{ env.DOCKERHUB_USERNAME }}/n8n-chinese-enterprise:${{ steps.get_n8n_version.outputs.n8n_version }}'"
        echo "æœ€æ–°æ ‡ç­¾: '${{ env.DOCKERHUB_USERNAME }}/n8n-chinese-enterprise:latest'"
        echo "----------------------------------"

    - name: æ„å»ºå¹¶æ¨é€ä¼ä¸šç‰ˆ Docker é•œåƒ # æ­¥éª¤11: æ„å»ºå¹¶æ¨é€ä¼ä¸šç‰ˆDockeré•œåƒ
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      uses: docker/build-push-action@v5 # æ¨èä½¿ç”¨æ­¤å®˜æ–¹actionï¼Œä¸€æ­¥å®Œæˆæ„å»ºå’Œæ¨é€
      with:
        context: . # Dockerfile æ‰€åœ¨çš„ä¸Šä¸‹æ–‡è·¯å¾„
        file: ./Dockerfile.enterprise # ä½¿ç”¨ä¼ä¸šç‰ˆ Dockerfile
        push: true # å¯ç”¨æ¨é€
        # å®šä¹‰è¦æ¨é€çš„æ ‡ç­¾ï¼Œæ¯è¡Œä¸€ä¸ª
        tags: |
          ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese-enterprise:${{ steps.get_n8n_version.outputs.n8n_version }}
          ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese-enterprise:latest
        cache-from: type=gha # å¯ç”¨GitHub Actionsç¼“å­˜
        cache-to: type=gha,mode=max # å°†æ„å»ºç¼“å­˜å†™å…¥GitHub Actions

    - name: åˆ›å»ºä¼ä¸šç‰ˆ README # æ­¥éª¤12: åˆ›å»ºä¼ä¸šç‰ˆè¯´æ˜æ–‡ä»¶
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        NEW_VERSION="${{ steps.get_n8n_version.outputs.n8n_version }}"
        DOCKER_USER="${{ env.DOCKERHUB_USERNAME }}" # è·å–æ¸…ç†åçš„ Docker Hub ç”¨æˆ·å
        echo "æ­£åœ¨åˆ›å»ºä¼ä¸šç‰ˆ README æ–‡ä»¶ï¼Œç‰ˆæœ¬: $NEW_VERSION (Docker ç”¨æˆ·: $DOCKER_USER)"

        cat <<EOF > README-ENTERPRISE.md
        # n8n ä¸­æ–‡ä¼ä¸šç‰ˆ Docker é•œåƒ

        ## æ¦‚è¿°

        è¿™æ˜¯åŸºäº [n8n ä¸­æ–‡ç‰ˆ](${DOCKER_USER}/n8n-chinese) çš„ä¼ä¸šç‰ˆé•œåƒï¼ŒåŒ…å«æ¨¡æ‹Ÿçš„ä¼ä¸šåŠŸèƒ½ï¼Œè§£é”æ‰€æœ‰é«˜çº§ç‰¹æ€§ã€‚

        ## åŠŸèƒ½ç‰¹æ€§

        âœ… **å®Œæ•´ä¼ä¸šåŠŸèƒ½æ¨¡æ‹Ÿ**
        - é«˜çº§æƒé™ç®¡ç†
        - å·¥ä½œæµå…±äº«
        - LDAP/SAML èº«ä»½è®¤è¯
        - æºä»£ç æ§åˆ¶
        - å˜é‡æ”¯æŒ
        - å¤–éƒ¨å¯†é’¥ç®¡ç†
        - å·¥ä½œæµå†å²è®°å½•
        - æ—¥å¿—æµå¤„ç†
        - å¤šä¸»å®ä¾‹
        - S3 äºŒè¿›åˆ¶æ•°æ®å­˜å‚¨
        - è°ƒè¯•æ¨¡å¼
        - å·¥ä½œè€…è§†å›¾
        - AI ç§¯åˆ† (999,999)
        - æ–‡ä»¶å¤¹ç®¡ç†
        - é¡¹ç›®è§’è‰²ç®¡ç†
        - è‡ªå®šä¹‰ NPM æ³¨å†Œè¡¨

        ## é•œåƒæ ‡ç­¾

        - ç‰ˆæœ¬æ ‡ç­¾: \`${DOCKER_USER}/n8n-chinese-enterprise:${NEW_VERSION}\`
        - æœ€æ–°æ ‡ç­¾: \`${DOCKER_USER}/n8n-chinese-enterprise:latest\`

        ## å¿«é€Ÿå¯åŠ¨

        \`\`\`bash
        # åŸºç¡€è¿è¡Œ
        docker run -d -p 5678:5678 ${DOCKER_USER}/n8n-chinese-enterprise:latest

        # å®Œæ•´é…ç½®è¿è¡Œï¼ˆæ¨èï¼‰
        docker run -d \\
          -p 5678:5678 \\
          -e N8N_DEFAULT_LOCALE=zh-CN \\
          -e GENERIC_TIMEZONE=Asia/Shanghai \\
          -e DB_TYPE=postgresdb \\
          -e DB_POSTGRESDB_HOST=postgres \\
          -e DB_POSTGRESDB_DATABASE=n8n \\
          -e DB_POSTGRESDB_USER=n8n \\
          -e DB_POSTGRESDB_PASSWORD=your_secure_password \\
          -e N8N_BASIC_AUTH_ACTIVE=true \\
          -e N8N_BASIC_AUTH_USER=admin \\
          -e N8N_BASIC_AUTH_PASSWORD=your_admin_password \\
          -e N8N_ENCRYPTION_KEY=your_32_char_hex_key \\
          ${DOCKER_USER}/n8n-chinese-enterprise:latest
        \`\`\`

        ## Docker Compose éƒ¨ç½²

        \`\`\`yaml
        version: '3.8'
        services:
          n8n:
            image: ${DOCKER_USER}/n8n-chinese-enterprise:${NEW_VERSION}
            ports:
              - "5678:5678"
            environment:
              - N8N_DEFAULT_LOCALE=zh-CN
              - GENERIC_TIMEZONE=Asia/Shanghai
              - DB_TYPE=postgresdb
              - DB_POSTGRESDB_HOST=postgres
              - DB_POSTGRESDB_DATABASE=n8n
              - DB_POSTGRESDB_USER=n8n
              - DB_POSTGRESDB_PASSWORD=n8n_password
              - N8N_BASIC_AUTH_ACTIVE=true
              - N8N_BASIC_AUTH_USER=admin
              - N8N_BASIC_AUTH_PASSWORD=admin_password
              - N8N_ENCRYPTION_KEY=your_32_char_hex_key_here
            depends_on:
              - postgres
            volumes:
              - n8n_data:/home/node/.n8n

          postgres:
            image: postgres:13
            environment:
              - POSTGRES_DB=n8n
              - POSTGRES_USER=n8n
              - POSTGRES_PASSWORD=n8n_password
            volumes:
              - postgres_data:/var/lib/postgresql/data

        volumes:
          n8n_data:
          postgres_data:
        \`\`\`

        ## ä¼ä¸šåŠŸèƒ½è¯´æ˜

        æœ¬é•œåƒé€šè¿‡æ¨¡æ‹Ÿæˆæƒæ–¹å¼è§£é”äº† n8n çš„ä¼ä¸šåŠŸèƒ½ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š

        1. **æ— é™åˆ¶é…é¢** - æ‰€æœ‰èµ„æºé…é¢è®¾ç½®ä¸ºæ— é™åˆ¶
        2. **å®Œæ•´åŠŸèƒ½é›†** - æ‰€æœ‰ä¼ä¸šåŠŸèƒ½å‡å¯ç”¨
        3. **é«˜çº§è®¤è¯** - æ”¯æŒ LDAP/SAML é›†æˆ
        4. **åä½œåŠŸèƒ½** - å·¥ä½œæµå…±äº«å’Œå›¢é˜Ÿç®¡ç†
        5. **é«˜çº§ç›‘æ§** - å·¥ä½œæµå†å²å’Œæ—¥å¿—æµ
        6. **æ‰©å±•æ”¯æŒ** - è‡ªå®šä¹‰ NPM åŒ…å’Œå¤–éƒ¨æœåŠ¡

        ## æ³¨æ„äº‹é¡¹

        - æ­¤é•œåƒä»…ç”¨äºæµ‹è¯•å’Œå¼€å‘ç›®çš„
        - ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨å®˜æ–¹æˆæƒçš„ä¼ä¸šç‰ˆæœ¬
        - ä¼ä¸šåŠŸèƒ½æ¨¡æ‹Ÿå¯èƒ½éš n8n ç‰ˆæœ¬æ›´æ–°è€Œå¤±æ•ˆ

        ## ç‰ˆæœ¬ä¿¡æ¯

        - n8n ç‰ˆæœ¬: ${NEW_VERSION}
        - æ„å»ºæ—¶é—´: \$(date)
        - ä¸Šæ¸¸ä»“åº“: ${UPSTREAM_REPO}

        ## ç›¸å…³é“¾æ¥

        - [åŸºç¡€ä¸­æ–‡ç‰ˆé•œåƒ](${DOCKER_USER}/n8n-chinese)
        - [ä¸Šæ¸¸ä»“åº“](https://github.com/${UPSTREAM_REPO})
        - [n8n å®˜æ–¹æ–‡æ¡£](https://docs.n8n.io/)
        EOF

        echo "ä¼ä¸šç‰ˆ README æ–‡ä»¶å·²åˆ›å»º"

    - name: æäº¤ä¼ä¸šç‰ˆæ›´æ–° # æ­¥éª¤13: æäº¤ä¼ä¸šç‰ˆç›¸å…³æ–‡ä»¶
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        NEW_VERSION="${{ steps.get_n8n_version.outputs.n8n_version }}"
        DOCKER_USER="${{ env.DOCKERHUB_USERNAME }}" # è·å–æ¸…ç†åçš„ Docker Hub ç”¨æˆ·å
        UPSTREAM_TAG="${{ steps.get_release.outputs.tag }}"
        ENTERPRISE_TAG="${UPSTREAM_TAG}-enterprise" # ä¼ä¸šç‰ˆæ ‡ç­¾åç¼€

        echo "æ­£åœ¨æäº¤ä¼ä¸šç‰ˆæ›´æ–°ï¼Œç‰ˆæœ¬: $NEW_VERSION (ä¼ä¸šç‰ˆæ ‡ç­¾: $ENTERPRISE_TAG)"

        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # æäº¤æ›´æ–°
        git add README-ENTERPRISE.md
        if git diff --staged --quiet; then
          echo "README-ENTERPRISE.md æ²¡æœ‰å˜åŒ–ã€‚"
        else
          echo "ğŸ¤– è‡ªåŠ¨æ›´æ–°ä¼ä¸šç‰ˆ README ç‰ˆæœ¬æ ‡ç­¾è‡³ ${NEW_VERSION}" > commit_message.txt
          echo "" >> commit_message.txt
          echo "- æ›´æ–°ä¼ä¸šç‰ˆ ${DOCKER_USER}/n8n-chinese-enterprise ç‰ˆæœ¬æ ‡ç­¾å¼•ç”¨" >> commit_message.txt
          echo "- ç‰ˆæœ¬å·: ${NEW_VERSION}" >> commit_message.txt
          echo "- ä¼ä¸šç‰ˆåŠŸèƒ½æ¨¡æ‹Ÿé›†æˆ" >> commit_message.txt
          echo "" >> commit_message.txt
          echo "ğŸ¤– ç”± GitHub Actions ç”Ÿæˆ" >> commit_message.txt
          echo "" >> commit_message.txt
          echo "Co-Authored-By: GitHub Action <action@github.com>" >> commit_message.txt

          git commit -F commit_message.txt
          rm commit_message.txt
          # æ¨é€æ–°çš„ä¼ä¸šç‰ˆ Git Tag åˆ°å½“å‰ä»“åº“ï¼Œä»¥æ ‡è®°æ­¤ç‰ˆæœ¬å·²å¤„ç†
          git tag "$ENTERPRISE_TAG" # ä½¿ç”¨ä¼ä¸šç‰ˆæ ‡ç­¾
          git push origin "$ENTERPRISE_TAG" # æ¨é€æ–°åˆ›å»ºçš„ Git Tag
          git push # æ¨é€ README-ENTERPRISE.md çš„æ›´æ–°
        fi