name: æ„å»º n8n ä¸­æ–‡ç¤¾åŒºç‰ˆå’Œä¼ä¸šç‰ˆ Docker é•œåƒ

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      force_build_community:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºç¤¾åŒºç‰ˆ (å³ä½¿å·²å­˜åœ¨)'
        required: false
        type: boolean
        default: false
      force_build_enterprise:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºä¼ä¸šç‰ˆ (å³ä½¿å·²å­˜åœ¨)'
        required: false
        type: boolean
        default: false

env:
  UPSTREAM_REPO: other-blowsnow/n8n-i18n-chinese

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_release.outputs.tag }}
      asset_url: ${{ steps.get_release.outputs.asset_url }}
      n8n_version: ${{ steps.get_n8n_version.outputs.n8n_version }}
      build_community: ${{ steps.check_images.outputs.build_community }}
      build_enterprise: ${{ steps.check_images.outputs.build_enterprise }}
      should_run_anything: ${{ steps.check_images.outputs.should_run_anything }}

    steps:
      - name: æ‹‰å–å½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: è·å–ä¸Šæ¸¸æœ€æ–°å‘å¸ƒä¿¡æ¯
        id: get_release
        run: |
          latest_release=$(curl -s https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest)
          tag=$(echo "$latest_release" | jq -r .tag_name | xargs)
          asset_url=$(echo "$latest_release" | jq -r '.assets[] | select(.name|endswith(".tar.gz")) | .browser_download_url' | xargs)
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "asset_url=$asset_url" >> "$GITHUB_OUTPUT"

      - name: ä»æ ‡ç­¾ä¸­æå– n8n ç‰ˆæœ¬å·
        id: get_n8n_version
        run: |
          TAG_REF="${{ steps.get_release.outputs.tag }}"
          N8N_VERSION=$(echo "${TAG_REF#n8n@}" | xargs)
          echo "n8n_version=$N8N_VERSION" >> "$GITHUB_OUTPUT"
          echo "æ£€æµ‹åˆ°ä¸Šæ¸¸ç‰ˆæœ¬: ${N8N_VERSION}"

      - name: è®¾ç½® Docker Buildx ç”¨äºå¤šæ¶æ„æ£€æŸ¥
        uses: docker/setup-buildx-action@v3

      - name: æ£€æŸ¥ Docker Hub ä¸Šçš„å¤šæ¶æ„é•œåƒæ˜¯å¦å­˜åœ¨
        id: check_images
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          N8N_VERSION: ${{ steps.get_n8n_version.outputs.n8n_version }}
        run: |
          BUILD_COMMUNITY="false"
          BUILD_ENTERPRISE="false"

          # æ£€æŸ¥ç¤¾åŒºç‰ˆé•œåƒ
          COMMUNITY_IMAGE="${DOCKERHUB_USERNAME}/n8n-chinese"
          COMMUNITY_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/repositories/${COMMUNITY_IMAGE}/tags/${N8N_VERSION}")
          echo "æ£€æŸ¥ç¤¾åŒºç‰ˆé•œåƒ ${COMMUNITY_IMAGE}:${N8N_VERSION} -> çŠ¶æ€ç : ${COMMUNITY_STATUS}"

          if [[ "${{ github.event.inputs.force_build_community }}" == "true" || "$COMMUNITY_STATUS" != "200" ]]; then
            BUILD_COMMUNITY="true"
            echo "éœ€è¦æ„å»ºç¤¾åŒºç‰ˆé•œåƒ: å¼ºåˆ¶æ„å»º=${{ github.event.inputs.force_build_community }}, é•œåƒä¸å­˜åœ¨=$([[ "$COMMUNITY_STATUS" != "200" ]] && echo true || echo false)"
          else
            # å¦‚æœé•œåƒå­˜åœ¨ï¼Œè¿›ä¸€æ­¥æ£€æŸ¥å¤šæ¶æ„æ”¯æŒ
            echo "æ­£åœ¨æ£€æŸ¥ç¤¾åŒºç‰ˆé•œåƒçš„å¤šæ¶æ„æ”¯æŒ..."
            docker buildx imagetools inspect "${COMMUNITY_IMAGE}:${N8N_VERSION}" 2>/dev/null && {
              HAS_AMD64=$(docker buildx imagetools inspect "${COMMUNITY_IMAGE}:${N8N_VERSION}" | grep -q "Platform:    linux/amd64" && echo "true" || echo "false")
              HAS_ARM64=$(docker buildx imagetools inspect "${COMMUNITY_IMAGE}:${N8N_VERSION}" | grep -q "Platform:    linux/arm64" && echo "true" || echo "false")
              echo "æ¶æ„æ£€æŸ¥ç»“æœ: AMD64=$HAS_AMD64, ARM64=$HAS_ARM64"
              if [[ "$HAS_AMD64" == "true" && "$HAS_ARM64" == "true" ]]; then
                echo "ç¤¾åŒºç‰ˆé•œåƒå·²æ”¯æŒ linux/amd64 å’Œ linux/arm64 æ¶æ„"
              else
                echo "ç¤¾åŒºç‰ˆé•œåƒæ¶æ„ä¸å®Œæ•´: AMD64=$HAS_AMD64, ARM64=$HAS_ARM64"
                BUILD_COMMUNITY="true"
              fi
            } || {
              echo "æ— æ³•æ£€æŸ¥ç¤¾åŒºç‰ˆé•œåƒæ¶æ„ï¼Œéœ€è¦é‡æ–°æ„å»º"
              BUILD_COMMUNITY="true"
            }
          fi

          # æ£€æŸ¥ä¼ä¸šç‰ˆé•œåƒ
          ENTERPRISE_IMAGE="${DOCKERHUB_USERNAME}/n8n-chinese-enterprise"
          ENTERPRISE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/repositories/${ENTERPRISE_IMAGE}/tags/${N8N_VERSION}")
          echo "æ£€æŸ¥ä¼ä¸šç‰ˆé•œåƒ ${ENTERPRISE_IMAGE}:${N8N_VERSION} -> çŠ¶æ€ç : ${ENTERPRISE_STATUS}"

          if [[ "${{ github.event.inputs.force_build_enterprise }}" == "true" || "$ENTERPRISE_STATUS" != "200" ]]; then
            BUILD_ENTERPRISE="true"
            echo "éœ€è¦æ„å»ºä¼ä¸šç‰ˆé•œåƒ: å¼ºåˆ¶æ„å»º=${{ github.event.inputs.force_build_enterprise }}, é•œåƒä¸å­˜åœ¨=$([[ "$ENTERPRISE_STATUS" != "200" ]] && echo true || echo false)"
          else
            # å¦‚æœé•œåƒå­˜åœ¨ï¼Œè¿›ä¸€æ­¥æ£€æŸ¥å¤šæ¶æ„æ”¯æŒ
            echo "æ­£åœ¨æ£€æŸ¥ä¼ä¸šç‰ˆé•œåƒçš„å¤šæ¶æ„æ”¯æŒ..."
            docker buildx imagetools inspect "${ENTERPRISE_IMAGE}:${N8N_VERSION}" 2>/dev/null && {
              HAS_AMD64=$(docker buildx imagetools inspect "${ENTERPRISE_IMAGE}:${N8N_VERSION}" | grep -q "Platform:    linux/amd64" && echo "true" || echo "false")
              HAS_ARM64=$(docker buildx imagetools inspect "${ENTERPRISE_IMAGE}:${N8N_VERSION}" | grep -q "Platform:    linux/arm64" && echo "true" || echo "false")
              echo "æ¶æ„æ£€æŸ¥ç»“æœ: AMD64=$HAS_AMD64, ARM64=$HAS_ARM64"
              if [[ "$HAS_AMD64" == "true" && "$HAS_ARM64" == "true" ]]; then
                echo "ä¼ä¸šç‰ˆé•œåƒå·²æ”¯æŒ linux/amd64 å’Œ linux/arm64 æ¶æ„"
              else
                echo "ä¼ä¸šç‰ˆé•œåƒæ¶æ„ä¸å®Œæ•´: AMD64=$HAS_AMD64, ARM64=$HAS_ARM64"
                BUILD_ENTERPRISE="true"
              fi
            } || {
              echo "æ— æ³•æ£€æŸ¥ä¼ä¸šç‰ˆé•œåƒæ¶æ„ï¼Œéœ€è¦é‡æ–°æ„å»º"
              BUILD_ENTERPRISE="true"
            }
          fi

          echo "build_community=${BUILD_COMMUNITY}" >> "$GITHUB_OUTPUT"
          echo "build_enterprise=${BUILD_ENTERPRISE}" >> "$GITHUB_OUTPUT"

          if [[ "$BUILD_COMMUNITY" == "true" || "$BUILD_ENTERPRISE" == "true" ]]; then
            echo "should_run_anything=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run_anything=false" >> "$GITHUB_OUTPUT"
            echo "æ‰€æœ‰å¤šæ¶æ„é•œåƒå‡å·²å­˜åœ¨ä¸”æœªå¼ºåˆ¶æ„å»ºï¼Œæ— éœ€æ‰§è¡Œä»»ä½•æ“ä½œã€‚"
          fi

  build-and-push-community:
    needs: check
    if: needs.check.outputs.build_community == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Docker Hub ç”¨æˆ·å
        run: echo "DOCKERHUB_USERNAME=$(echo '${{ secrets.DOCKERHUB_USERNAME }}' | xargs)" >> "$GITHUB_ENV"

      - name: ä¸‹è½½å¹¶è§£å‹
        run: |
          mkdir -p src-dist
          curl -L "${{ needs.check.outputs.asset_url }}" -o src-dist/editor-ui.tar.gz
          tar -xzvf src-dist/editor-ui.tar.gz -C src-dist
          
      - name: ç™»å½•åˆ° Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ„å»ºå¹¶æ¨é€ç¤¾åŒºç‰ˆ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.community
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ needs.check.outputs.n8n_version }}
            ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            N8N_VERSION=${{ needs.check.outputs.n8n_version }}

      - name: å¯¼å‡ºç¤¾åŒºç‰ˆé•œåƒ
        run: |
          echo "ğŸ“¦ å¼€å§‹å¯¼å‡ºç¤¾åŒºç‰ˆé•œåƒ..."
          mkdir -p docker-images
          docker pull ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ needs.check.outputs.n8n_version }}
          echo "æ­£åœ¨å¯¼å‡ºé•œåƒ ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ needs.check.outputs.n8n_version }}..."
          docker save ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ needs.check.outputs.n8n_version }} | \
            gzip > "docker-images/n8n-chinese-${{ needs.check.outputs.n8n_version }}.tar.gz"

      - name: åˆ›å»ºæ–‡æ¡£
        run: |
          # ä½¿ç”¨ printf åˆ›å»º README æ–‡ä»¶ï¼Œé¿å… heredoc é—®é¢˜
          printf '# n8n ä¸­æ–‡ç‰ˆ Docker é•œåƒ\n\n## é•œåƒä¿¡æ¯\n- ç‰ˆæœ¬: %s\n- é•œåƒ: %s\n- æ¶æ„: linux/amd64, linux/arm64\n\n## å¯¼å…¥é•œåƒ\n\n1. å°†é•œåƒæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°\n2. ç›´æ¥å¯¼å…¥é•œåƒï¼ˆæ— éœ€è§£å‹ï¼‰ï¼š\n   ```bash\n   docker load -i n8n-chinese-%s.tar.gz\n   ```\n   \n   æˆ–ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\n   ```bash\n   docker load < n8n-chinese-%s.tar.gz\n   ```\n\n## è¿è¡Œå®¹å™¨\n\n```bash\ndocker run -d --name n8n \\\n  -p 5678:5678 \\\n  -v n8n_data:/home/node/.n8n \\\n  %s\n```\n\n## æ›´å¤šä¿¡æ¯\n\n- é¡¹ç›®ä¸»é¡µ: https://github.com/msola-ht/n8n-i18n-chinese-docker\n- Docker Hub: https://hub.docker.com/r/%s/n8n-chinese\n' \
            "${{ needs.check.outputs.n8n_version }}" \
            "${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ needs.check.outputs.n8n_version }}" \
            "${{ needs.check.outputs.n8n_version }}" \
            "${{ needs.check.outputs.n8n_version }}" \
            "${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ needs.check.outputs.n8n_version }}" \
            "${{ env.DOCKERHUB_USERNAME }}" \
            > docker-images/README.md

      - name: ç”Ÿæˆé•œåƒä¿¡æ¯
        run: |
          echo '{' > docker-images/image-info.json
          echo '  "version": "${{ needs.check.outputs.n8n_version }}",' >> docker-images/image-info.json
          echo '  "image": "${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ needs.check.outputs.n8n_version }}",' >> docker-images/image-info.json
          echo '  "platforms": ["linux/amd64", "linux/arm64"],' >> docker-images/image-info.json
          echo '  "build_date": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",' >> docker-images/image-info.json
          echo '  "upstream_tag": "${{ needs.check.outputs.tag }}"' >> docker-images/image-info.json
          echo '}' >> docker-images/image-info.json

      - name: è¾“å‡ºå¯¼å‡ºä¿¡æ¯
        run: |
          echo "::notice::é•œåƒå·²å¯¼å‡ºä¸º: docker-images/n8n-chinese-${{ needs.check.outputs.n8n_version }}.tar.gz"
          echo "::notice::é•œåƒå¤§å°: $(du -h docker-images/n8n-chinese-${{ needs.check.outputs.n8n_version }}.tar.gz | cut -f1)"

      - name: ä¸Šä¼ é•œåƒå½’æ¡£åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: n8n-chinese-image-${{ needs.check.outputs.n8n_version }}
          path: docker-images/
          retention-days: 30

      - name: è¾“å‡ºç¤¾åŒºç‰ˆæ„å»ºä¿¡æ¯
        run: |
          echo "âœ… ç¤¾åŒºç‰ˆé•œåƒæ„å»ºæˆåŠŸ"
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ needs.check.outputs.n8n_version }}"
          echo "ğŸ—ï¸  æ”¯æŒæ¶æ„: linux/amd64, linux/arm64"
          echo "ğŸ”— Docker Hub: https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/n8n-chinese"
          echo "ğŸ’¾ é•œåƒå½’æ¡£: å·²ä¸Šä¼ åˆ° GitHub Actions Artifacts"

  build-and-push-enterprise:
    needs: [check, build-and-push-community]
    if: always() && needs.check.outputs.build_enterprise == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Docker Hub ç”¨æˆ·å
        run: echo "DOCKERHUB_USERNAME=$(echo '${{ secrets.DOCKERHUB_USERNAME }}' | xargs)" >> "$GITHUB_ENV"

      - name: å‡†å¤‡ä¼ä¸šç‰ˆæ–‡ä»¶
        # è¿™é‡Œè¿›è¡Œäº†æ‹†åˆ†ï¼šå…ˆç”Ÿæˆ JS æ–‡ä»¶ï¼Œå†ç”Ÿæˆ Dockerfileï¼Œé¿å…åµŒå¥— Heredoc é”™è¯¯
        run: |
          # 1. ç”Ÿæˆ Mock JS æ–‡ä»¶
          cat <<'JSEOF' > enterprise-mock.js
          const originalInit = BaseCommand.prototype.init; const originalInitLicense = BaseCommand.prototype.initLicense; function initEnterpriseMock() { const { Container } = require("@n8n/di"); const { License } = require("../license"); const { LICENSE_QUOTAS, LICENSE_FEATURES, UNLIMITED_LICENSE_QUOTA } = require("@n8n/constants"); try { const license = Container.get(License); if (!license) { console.warn("[ENTERPRISE MOCK] License service not available"); return; } license.isLicensed = function(feature) { if (feature === "feat:showNonProdBanner") { return false; } return true; }; const origialGetValue = license.getValue.bind(license); license.getValue = (feature) => { if (feature === "planName") { return "Enterprise (Mocked)"; } if (Object.values(LICENSE_QUOTAS).includes(feature)) { return UNLIMITED_LICENSE_QUOTA; } if (Object.values(LICENSE_FEATURES).includes(feature)) { return true; } return origialGetValue(feature); }; ["isAdvancedPermissionsLicensed", "isSharingEnabled", "isLdapEnabled", "isSamlEnabled", "isSourceControlLicensed", "isVariablesEnabled", "isExternalSecretsEnabled", "isWorkflowHistoryLicensed", "isLogStreamingEnabled", "isMultiMainLicensed", "isBinaryDataS3Licensed", "isDebugInEditorLicensed", "isWorkerViewLicensed", "isAiCreditsEnabled", "isFoldersEnabled", "isProjectRoleAdminLicensed", "isProjectRoleEditorLicensed", "isProjectRoleViewerLicensed", "isCustomNpmRegistryEnabled", "isWithinUsersLimit"].forEach((key) => { license[key] = () => true; }); ["getUsersLimit", "getTriggerLimit", "getVariablesLimit", "getWorkflowHistoryPruneLimit", "getTeamProjectLimit"].forEach((key) => { license[key] = () => UNLIMITED_LICENSE_QUOTA; }); license.isAPIDisabled = () => false; license.isAiAssistantEnabled = () => false; license.getAiCredits = () => 999999; license.getPlanName = () => "Enterprise (Mocked)"; license.getConsumerId = () => "enterprise-mock-consumer"; license.getManagementJwt = () => "mock-jwt-token"; console.log("[ENTERPRISE MOCK] âœ… All enterprise features enabled"); } catch (error) { console.error("[ENTERPRISE MOCK] Failed to enable enterprise mock:", error); } } BaseCommand.prototype.init = async function() { await originalInit.call(this); await this.initLicense(); }; BaseCommand.prototype.initLicense = async function() { await originalInitLicense.call(this); initEnterpriseMock(); };
          JSEOF

          # 2. ç”Ÿæˆ Dockerfile (ä½¿ç”¨ COPY æŒ‡ä»¤è€Œä¸æ˜¯å†…éƒ¨ç”Ÿæˆ)
          cat <<EOF > Dockerfile.enterprise
          FROM ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ needs.check.outputs.n8n_version }}
          USER root
          
          # å°†ä¸Šé¢ç”Ÿæˆçš„ JS æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­
          COPY enterprise-mock.js /tmp/enterprise-mock.js
          
          ENV TARGET_FILE=/usr/local/lib/node_modules/n8n/dist/commands/base-command.js
          
          # æ‰§è¡Œæ³¨å…¥é€»è¾‘
          RUN set -e; \
              awk '/^exports\.BaseCommand = BaseCommand;$/{system("cat /tmp/enterprise-mock.js")}1' \${TARGET_FILE} > \${TARGET_FILE}.tmp; \
              mv \${TARGET_FILE}.tmp \${TARGET_FILE}; \
              rm /tmp/enterprise-mock.js;
          
          USER node
          EOF
          
      - name: ç™»å½•åˆ° Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ„å»ºå¹¶æ¨é€ä¼ä¸šç‰ˆ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.enterprise
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese-enterprise:${{ needs.check.outputs.n8n_version }}
            ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese-enterprise:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: è¾“å‡ºä¼ä¸šç‰ˆæ„å»ºä¿¡æ¯
        run: |
          echo "âœ… ä¼ä¸šç‰ˆé•œåƒæ„å»ºæˆåŠŸ"
          echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese-enterprise:${{ needs.check.outputs.n8n_version }}"
          echo "ğŸ—ï¸  æ”¯æŒæ¶æ„: linux/amd64, linux/arm64"
          echo "ğŸ”— Docker Hub: https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/n8n-chinese-enterprise"
          echo "ğŸš€ ä¼ä¸šç‰ˆåŠŸèƒ½å·²å…¨éƒ¨å¯ç”¨"

  finalize_release:
    needs: [check, build-and-push-community, build-and-push-enterprise]
    if: always() && needs.check.outputs.should_run_anything == 'true' && (needs.build-and-push-community.result != 'failure' && needs.build-and-push-enterprise.result != 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: æ›´æ–°æ–‡æ¡£å’Œæ¨é€æ ‡ç­¾
        env:
          NEW_VERSION: ${{ needs.check.outputs.n8n_version }}
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          UPSTREAM_TAG: ${{ needs.check.outputs.tag }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git fetch --tags
          # æ›´æ–°é•œåƒæ ‡ç­¾ä¸­çš„ç‰ˆæœ¬å·
          sed -i "s|${DOCKER_USER}/n8n-chinese:[0-9.]*|${DOCKER_USER}/n8n-chinese:${NEW_VERSION}|g" README.md
          sed -i "s|${DOCKER_USER}/n8n-chinese-enterprise:[0-9.]*|${DOCKER_USER}/n8n-chinese-enterprise:${NEW_VERSION}|g" README.md

          # æ›´æ–°ç‰ˆæœ¬å·æ–‡æœ¬
          perl -i -pe 's/^- (\*\*ç‰ˆæœ¬\*\*: `)[0-9.]+(`)/$1'${NEW_VERSION}'$2/g' README.md
          
          git add README.md
          if ! git diff --staged --quiet; then
            git commit -m "ci: è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬æ ‡ç­¾è‡³ ${NEW_VERSION}"
            git push
          fi
          
          if ! git rev-parse -q --verify "refs/tags/${UPSTREAM_TAG}"; then
            git tag "${UPSTREAM_TAG}"
            git push origin "${UPSTREAM_TAG}"
          fi

  create_release:
    needs: [check, build-and-push-community]
    # åªæœ‰åœ¨æ„å»ºç¤¾åŒºç‰ˆæˆåŠŸæ—¶æ‰æ‰§è¡Œ
    if: always() && needs.check.outputs.should_run_anything == 'true' && needs.build-and-push-community.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: ä¸‹è½½é•œåƒå½’æ¡£
        uses: actions/download-artifact@v4
        with:
          name: n8n-chinese-image-${{ needs.check.outputs.n8n_version }}
          path: docker-images/

      - name: æ£€æŸ¥æ–‡ä»¶
        run: |
          echo "ä¸‹è½½çš„æ–‡ä»¶ï¼š"
          ls -la docker-images/

      - name: åˆ›å»ºæˆ–æ›´æ–° GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          N8N_VERSION: ${{ needs.check.outputs.n8n_version }}
          UPSTREAM_TAG: ${{ needs.check.outputs.tag }}
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ Release
          if gh release view "${UPSTREAM_TAG}" --json title --jq .title 2>/dev/null; then
            echo "Release ${UPSTREAM_TAG} å·²å­˜åœ¨ï¼Œæ›´æ–°èµ„äº§..."

            # åˆ é™¤æ—§çš„é•œåƒæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            OLD_ASSETS=$(gh release view "${UPSTREAM_TAG}" --json assets --jq '.assets[] | select(.name | startswith("n8n-chinese-")) | .name')
            if [ -n "$OLD_ASSETS" ]; then
              echo "$OLD_ASSETS" | xargs -I {} gh release delete-asset "${UPSTREAM_TAG}" "{}" --yes
            fi

            # ä¸Šä¼ æ–°çš„é•œåƒæ–‡ä»¶
            gh release upload "${UPSTREAM_TAG}" \
              "docker-images/n8n-chinese-${N8N_VERSION}.tar.gz" \
              "docker-images/README.md" \
              "docker-images/image-info.json"
          else
            echo "åˆ›å»ºæ–°çš„ Release ${UPSTREAM_TAG}..."

            # åˆ›å»º Release
            NOTES_FILE="/tmp/release-notes.txt"
            printf '## n8n ä¸­æ–‡ç‰ˆ Docker é•œåƒ\n\nç‰ˆæœ¬ï¼š%s\né•œåƒï¼š%s/n8n-chinese:%s\n\n### æ–°å¢åŠŸèƒ½\n- ğŸ³ å®Œæ•´çš„ä¸­æ–‡ç•Œé¢æ”¯æŒ\n- ğŸ—ï¸ å¤šæ¶æ„æ”¯æŒï¼ˆlinux/amd64, linux/arm64ï¼‰\n- ğŸ“¦ Docker é•œåƒç¦»çº¿å¯¼å…¥åŒ…\n- ğŸš€ å¼€ç®±å³ç”¨çš„ä¸­æ–‡ç¯å¢ƒ\n\n### ä½¿ç”¨æ–¹æ³•\n\n#### ä» Docker Hub æ‹‰å–\n```bash\ndocker run -d --name n8n \\\n  -p 5678:5678 \\\n  -v n8n_data:/home/node/.n8n \\\n  %s/n8n-chinese:%s\n```\n\n#### ç¦»çº¿å¯¼å…¥ï¼ˆä¸‹è½½ä¸‹æ–¹ tar.gz æ–‡ä»¶ï¼‰\n1. ä¸‹è½½ n8n-chinese-%s.tar.gz\n2. ç›´æ¥å¯¼å…¥é•œåƒï¼ˆæ— éœ€è§£å‹ï¼‰ï¼š\n   ```bash\n   docker load -i n8n-chinese-%s.tar.gz\n   ```\n   \n   æˆ–ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\n   ```bash\n   docker load < n8n-chinese-%s.tar.gz\n   ```\n\n### æ›´å¤šä¿¡æ¯\n- é¡¹ç›®ä¸»é¡µï¼šhttps://github.com/msola-ht/n8n-i18n-chinese-docker\n- Docker Hubï¼šhttps://hub.docker.com/r/%s/n8n-chinese\n- ä¸Šæ¸¸é¡¹ç›®ï¼šhttps://github.com/other-blowsnow/n8n-i18n-chinese' \
              "${N8N_VERSION}" \
              "${DOCKER_USER}" "${N8N_VERSION}" \
              "${DOCKER_USER}" "${N8N_VERSION}" \
              "${N8N_VERSION}" "${N8N_VERSION}" "${N8N_VERSION}" \
              "${DOCKER_USER}" \
              > "${NOTES_FILE}"

            gh release create "${UPSTREAM_TAG}" \
              "docker-images/n8n-chinese-${N8N_VERSION}.tar.gz" \
              "docker-images/README.md" \
              "docker-images/image-info.json" \
              --title "n8n ä¸­æ–‡ç‰ˆ v${N8N_VERSION}" \
              --notes-file "${NOTES_FILE}"
          fi

          echo "âœ… Release ${UPSTREAM_TAG} å·²æ›´æ–°å®Œæˆ"
