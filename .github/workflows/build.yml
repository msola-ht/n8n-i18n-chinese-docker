name: Build n8n Chinese Editor-UI Docker Image

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡

env:
  UPSTREAM_REPO: other-blowsnow/n8n-i18n-chinese

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository # æ­¥éª¤1: æ‹‰å–å½“å‰ä»“åº“ä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼ŒåŒ…æ‹¬æ ‡ç­¾ï¼Œä»¥ä¾¿æ£€æŸ¥

    - name: è·å–ä¸Šæ¸¸æœ€æ–° Release # æ­¥éª¤2: ä»ä¸Šæ¸¸ä»“åº“è·å–æœ€æ–°å‘å¸ƒä¿¡æ¯
      id: get_release
      run: |
        latest_release=$(curl -s https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest)
        # ä½¿ç”¨ xargs ç¡®ä¿å»é™¤æ‰€æœ‰å‰å¯¼å’Œå°¾éƒ¨ç©ºæ ¼
        tag=$(echo "$latest_release" | jq -r .tag_name | xargs) # è·å–ä¸Šæ¸¸çš„ Git Tagï¼Œä¾‹å¦‚ n8n@1.115.3
        asset_url=$(echo "$latest_release" | jq -r '.assets[] | select(.name|endswith(".tar.gz")) | .browser_download_url' | xargs) # è·å–ä¸‹è½½é“¾æ¥
        echo "tag=$tag" >> "$GITHUB_OUTPUT" # å°†tagè®¾ç½®ä¸ºè¾“å‡º
        echo "asset_url=$asset_url" >> "$GITHUB_OUTPUT" # å°†ä¸‹è½½é“¾æ¥è®¾ç½®ä¸ºè¾“å‡º
        echo "Detected upstream tag (quoted for clarity): '$tag'" # æ‰“å°å¸¦å¼•å·çš„tagï¼Œæ–¹ä¾¿è°ƒè¯•ç©ºæ ¼

    # æ–°å¢æ­¥éª¤ï¼šæ£€æŸ¥å½“å‰ä»“åº“æ˜¯å¦å·²å­˜åœ¨ä¸ä¸Šæ¸¸æœ€æ–° release ç›¸åŒçš„ Git Tag
    - name: æ£€æŸ¥æ˜¯å¦å·²å‘å¸ƒè¿‡æ­¤ç‰ˆæœ¬
      id: check_tag
      run: |
        UPSTREAM_TAG="${{ steps.get_release.outputs.tag }}"
        echo "æ­£åœ¨æ£€æŸ¥å½“å‰ä»“åº“æ˜¯å¦å·²å­˜åœ¨ Git Tag: '$UPSTREAM_TAG'"
        # ä½¿ç”¨ git ls-remote æ£€æŸ¥è¿œç¨‹ä»“åº“ï¼ˆoriginï¼‰ä¸­æ˜¯å¦å­˜åœ¨è¯¥æ ‡ç­¾
        # grep -q ç”¨äºé™é»˜è¾“å‡ºï¼Œåªè¿”å›é€€å‡ºçŠ¶æ€ç 
        if git ls-remote --tags origin | grep -q "refs/tags/$UPSTREAM_TAG$"; then
          echo "æ£€æµ‹åˆ°æ ‡ç­¾ '$UPSTREAM_TAG' å·²å­˜åœ¨äºå½“å‰ä»“åº“ï¼Œæ­¤ç‰ˆæœ¬å·²å‘å¸ƒè¿‡ã€‚"
          echo "exists=true" >> "$GITHUB_OUTPUT"
        else
          echo "æ ‡ç­¾ '$UPSTREAM_TAG' ä¸å­˜åœ¨äºå½“å‰ä»“åº“ï¼Œå°†ç»§ç»­æ„å»ºæ–°ç‰ˆæœ¬ã€‚"
          echo "exists=false" >> "$GITHUB_OUTPUT"
        fi

    # æ–°å¢æ­¥éª¤ï¼šå¦‚æœå·²å‘å¸ƒè¿‡ï¼Œåˆ™ç»ˆæ­¢ workflow
    - name: ç»ˆæ­¢ workflow å¦‚æœæ­¤ç‰ˆæœ¬å·²å‘å¸ƒ
      if: steps.check_tag.outputs.exists == 'true'
      run: |
        echo "æ£€æµ‹åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬å·²åœ¨å½“å‰ä»“åº“å‘å¸ƒè¿‡ï¼Œæ— éœ€é‡å¤æ„å»ºå’Œæ¨é€ã€‚Workflow å°†æå‰ç»ˆæ­¢ã€‚"
        # exit 0 è¡¨ç¤ºæˆåŠŸé€€å‡ºï¼ŒGitHub Actions ä¼šå°†æ­¤ job æ ‡è®°ä¸ºæˆåŠŸï¼Œå¹¶è·³è¿‡åç»­æ­¥éª¤ã€‚
        exit 0

    - name: Get N8N Version from Tag # æ­¥éª¤3: ä»ä¸Šæ¸¸Gitæ ‡ç­¾ä¸­æå–çº¯ç²¹çš„n8nç‰ˆæœ¬å·
      id: get_n8n_version
      run: |
        TAG_REF="${{ steps.get_release.outputs.tag }}"
        # æå–åå†æ¬¡ä½¿ç”¨ xargs ç¡®ä¿å»é™¤æ‰€æœ‰å‰å¯¼å’Œå°¾éƒ¨ç©ºæ ¼
        N8N_VERSION=$(echo "${TAG_REF#n8n@}" | xargs) # æå–å‡º '1.115.3'
        echo "n8n_version=$N8N_VERSION" >> "$GITHUB_OUTPUT" # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºè¾“å‡º
        echo "Extracted N8N Version (quoted for clarity): '$N8N_VERSION'" # æ‰“å°å¸¦å¼•å·çš„ç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿è°ƒè¯•ç©ºæ ¼

    - name: Debug Docker Hub Username # æ­¥éª¤4: æ£€æŸ¥ DOCKERHUB_USERNAME æ˜¯å¦æœ‰ç©ºæ ¼ï¼Œå¹¶æ¸…ç†
      run: |
        DOCKERHUB_USERNAME_VAL="${{ secrets.DOCKERHUB_USERNAME }}"
        echo "--- Debugging DOCKERHUB_USERNAME ---"
        echo "Username (quoted): '$DOCKERHUB_USERNAME_VAL'"
        echo "Length of username: ${#DOCKERHUB_USERNAME_VAL}"
        echo "------------------------------------"
        # å¢åŠ ä¸€ä¸ªé˜²å¾¡æ€§å¤„ç†ï¼Œç¡®ä¿ DOCKERHUB_USERNAME ä¸åŒ…å«ç©ºæ ¼ï¼Œå¹¶è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
        CLEAN_DOCKERHUB_USERNAME=$(echo "$DOCKERHUB_USERNAME_VAL" | xargs)
        echo "CLEAN_DOCKERHUB_USERNAME (quoted): '$CLEAN_DOCKERHUB_USERNAME'"
        echo "CLEAN_DOCKERHUB_USERNAME_LENGTH: ${#CLEAN_DOCKERHUB_USERNAME}"
        echo "DOCKERHUB_USERNAME=$CLEAN_DOCKERHUB_USERNAME" >> "$GITHUB_ENV" # å°†æ¸…ç†åçš„ç”¨æˆ·åè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨

    # ç§»é™¤äº†æ£€æŸ¥æœ¬åœ° Git Tag çš„æ­¥éª¤ï¼Œå› ä¸ºä¸å†éœ€è¦æœ¬åœ° Git Tag æ¥åˆ¤æ–­æ˜¯å¦è·³è¿‡æ„å»º
    # è¿™æ ·æ¯æ¬¡ä¸Šæ¸¸æœ‰æ–°ç‰ˆæœ¬ï¼Œéƒ½ä¼šå°è¯•æ„å»ºå¹¶æ¨é€åˆ° Docker Hub

    - name: ä¸‹è½½ä¸Šæ¸¸ release æ–‡ä»¶ # æ­¥éª¤5: ä¸‹è½½ä¸Šæ¸¸çš„ editor-ui dist æ–‡ä»¶
      run: |
        mkdir -p src-dist
        curl -L "${{ steps.get_release.outputs.asset_url }}" -o src-dist/editor-ui.tar.gz
        echo "Downloaded ${{ steps.get_release.outputs.asset_url }}"

    - name: è§£å‹ dist æ–‡ä»¶ # æ­¥éª¤6: è§£å‹ä¸‹è½½çš„ tar.gz æ–‡ä»¶
      run: |
        tar -xzvf src-dist/editor-ui.tar.gz -C src-dist
        echo "Extracted dist files to src-dist/dist"

    - name: ç”Ÿæˆ Dockerfile (å¤šé˜¶æ®µæ„å»º) # æ­¥éª¤7: åŠ¨æ€ç”Ÿæˆ Dockerfileï¼Œç°åœ¨ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
      run: |
        N8N_VERSION=${{ steps.get_n8n_version.outputs.n8n_version }} # ä½¿ç”¨æå–å‡ºçš„çº¯ç²¹ç‰ˆæœ¬å·
        echo "Generating Multi-stage Dockerfile for n8n version: $N8N_VERSION"
        cat <<EOF > Dockerfile
        # --- Stage 1: ui_holder (ç”¨äºä»æ„å»ºä¸Šä¸‹æ–‡å¤åˆ¶ dist æ–‡ä»¶) ---
        # è¿™ä¸€é˜¶æ®µä½¿ç”¨ä¸€ä¸ªè½»é‡çº§çš„åŸºç¡€é•œåƒï¼Œåªä¸ºäº†â€œæŒæœ‰â€æˆ‘ä»¬å·²ä¸‹è½½å’Œè§£å‹çš„ dist æ–‡ä»¶ã€‚
        # è¿™æ ·åšå¯ä»¥ç¡®ä¿æœ€ç»ˆé•œåƒåªåŒ…å«è¿™äº›æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ•´ä¸ª src-dist ç›®å½•çš„ä¸´æ—¶å†…å®¹ã€‚
        FROM alpine:latest as ui_holder
        WORKDIR /app
        # å°† GitHub Actions Runner ä¸Šå·²å­˜åœ¨çš„ src-dist/dist ç›®å½•å¤åˆ¶åˆ°è¿™ä¸€é˜¶æ®µçš„é•œåƒä¸­
        COPY src-dist/dist /app/dist

        # --- Stage 2: Final n8n Image (æœ€ç»ˆé•œåƒ) ---
        FROM n8nio/n8n:$N8N_VERSION
        USER root

        RUN apk update \\
            && apk add --no-cache ffmpeg \\
            && rm -rf /var/cache/apk/*

        USER node

        # ä» ui_holder é˜¶æ®µå¤åˆ¶çº¯å‡€çš„ dist æ–‡ä»¶åˆ° n8n çš„ editor-ui ç›®å½•
        COPY --from=ui_holder /app/dist /usr/local/lib/node_modules/n8n/node_modules/n8n-editor-ui/dist
        EOF
        cat Dockerfile # æ‰“å°ç”Ÿæˆçš„ Dockerfile å†…å®¹ä»¥ä¾›è°ƒè¯•

    - name: Set up Docker Buildx # æ­¥éª¤8: è®¾ç½®Docker Buildxï¼Œç”¨äºæ›´é«˜æ•ˆå’Œå®‰å…¨çš„æ„å»º
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub # æ­¥éª¤9: ç™»å½•åˆ°Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Debug Final Image Tags # æ­¥éª¤10: æ‰“å°æœ€ç»ˆçš„æ ‡ç­¾å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿è°ƒè¯•
      run: |
        # ä½¿ç”¨é€šè¿‡ $GITHUB_ENV è®¾ç½®çš„æ¸…ç†åçš„ DOCKERHUB_USERNAME
        echo "--- Debugging Final Image Tags ---"
        echo "Version Tag: '${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ steps.get_n8n_version.outputs.n8n_version }}'"
        echo "Latest Tag: '${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:latest'"
        echo "----------------------------------"

    - name: Build and push Docker image # æ­¥éª¤11: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ (åŒæ—¶æ‰“ä¸Šç‰ˆæœ¬å·å’Œlatestæ ‡ç­¾)
      uses: docker/build-push-action@v5 # æ¨èä½¿ç”¨æ­¤å®˜æ–¹actionï¼Œä¸€æ­¥å®Œæˆæ„å»ºå’Œæ¨é€
      with:
        context: . # Dockerfile æ‰€åœ¨çš„ä¸Šä¸‹æ–‡è·¯å¾„
        push: true # å¯ç”¨æ¨é€
        # å®šä¹‰è¦æ¨é€çš„æ ‡ç­¾ï¼Œæ¯è¡Œä¸€ä¸ª
        tags: |
          ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ steps.get_n8n_version.outputs.n8n_version }}
          ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:latest
        cache-from: type=gha # å¯ç”¨GitHub Actionsç¼“å­˜
        cache-to: type=gha,mode=max # å°†æ„å»ºç¼“å­˜å†™å…¥GitHub Actions

    - name: Update README with new version # æ­¥éª¤12: æ›´æ–°READMEä¸­çš„ç‰ˆæœ¬æ ‡ç­¾
      run: |
        NEW_VERSION="${{ steps.get_n8n_version.outputs.n8n_version }}"
        DOCKER_USER="${{ env.DOCKERHUB_USERNAME }}" # è·å–æ¸…ç†åçš„ Docker Hub ç”¨æˆ·å
        echo "Updating README.md with version: $NEW_VERSION for Docker user: $DOCKER_USER"

        # æ›´æ–° README.md ä¸­çš„ç‰ˆæœ¬æ ‡ç­¾
        # åŠ¨æ€æ›¿æ¢ Docker ç”¨æˆ·åå’Œç‰ˆæœ¬å·
        sed -i "s|${DOCKER_USER}/n8n-chinese:[0-9]\+\.[0-9]\+\.[0-9]\+|${DOCKER_USER}/n8n-chinese:$NEW_VERSION|g" README.md

        # æ˜¾ç¤ºæ›´æ–°å†…å®¹
        echo "Updated README.md content:"
        grep -n "${DOCKER_USER}/n8n-chinese:" README.md || true

        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # æäº¤æ›´æ–°
        git add README.md
        if git diff --staged --quiet; then
          echo "No changes to README.md"
        else
          echo "ğŸ¤– è‡ªåŠ¨æ›´æ–° README ç‰ˆæœ¬æ ‡ç­¾è‡³ ${NEW_VERSION}" > commit_message.txt
          echo "" >> commit_message.txt
          echo "- æ›´æ–°æ‰€æœ‰ ${DOCKER_USER}/n8n-chinese ç‰ˆæœ¬æ ‡ç­¾å¼•ç”¨" >> commit_message.txt
          echo "- ç‰ˆæœ¬å·: ${NEW_VERSION}" >> commit_message.txt
          echo "- è‡ªåŠ¨æ„å»ºæµç¨‹æ›´æ–°" >> commit_message.txt
          echo "" >> commit_message.txt
          echo "ğŸ¤– Generated with GitHub Actions" >> commit_message.txt
          echo "" >> commit_message.txt
          echo "Co-Authored-By: GitHub Action <action@github.com>" >> commit_message.txt

          git commit -F commit_message.txt
          rm commit_message.txt
          # æ¨é€æ–°çš„ Git Tag åˆ°å½“å‰ä»“åº“
          git tag "$UPSTREAM_TAG" # ä½¿ç”¨ä¸Šæ¸¸çš„ tag ä½œä¸ºå½“å‰ä»“åº“çš„ tag
          git push origin "$UPSTREAM_TAG"
          git push
        fi
