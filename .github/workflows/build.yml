name: æ„å»º n8n ä¸­æ–‡ç¼–è¾‘å™¨ UI Docker é•œåƒ

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼Œä¾‹å¦‚ UTC æ—¶é—´æ¯å°æ—¶çš„ç¬¬0åˆ†é’Ÿ

env:
  UPSTREAM_REPO: other-blowsnow/n8n-i18n-chinese # ä¸Šæ¸¸ä»“åº“åœ°å€

jobs:
  build-and-push:
    runs-on: ubuntu-latest # åœ¨ Ubuntu æœ€æ–°ç‰ˆç³»ç»Ÿä¸Šè¿è¡Œ

    steps:
    - name: æ‹‰å–å½“å‰ä»“åº“ä»£ç  # æ­¥éª¤1: æ‹‰å–å½“å‰ä»“åº“ä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼ŒåŒ…æ‹¬æ ‡ç­¾ï¼Œä»¥ä¾¿æ£€æŸ¥

    - name: è·å–ä¸Šæ¸¸æœ€æ–°å‘å¸ƒä¿¡æ¯ # æ­¥éª¤2: ä»ä¸Šæ¸¸ä»“åº“è·å–æœ€æ–°å‘å¸ƒä¿¡æ¯
      id: get_release
      run: |
        latest_release=$(curl -s https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest)
        # ä½¿ç”¨ xargs ç¡®ä¿å»é™¤æ‰€æœ‰å‰å¯¼å’Œå°¾éƒ¨ç©ºæ ¼
        tag=$(echo "$latest_release" | jq -r .tag_name | xargs) # è·å–ä¸Šæ¸¸çš„ Git Tagï¼Œä¾‹å¦‚ n8n@1.115.3
        asset_url=$(echo "$latest_release" | jq -r '.assets[] | select(.name|endswith(".tar.gz")) | .browser_download_url' | xargs) # è·å–ä¸‹è½½é“¾æ¥
        echo "tag=$tag" >> "$GITHUB_OUTPUT" # å°†tagè®¾ç½®ä¸ºè¾“å‡º
        echo "asset_url=$asset_url" >> "$GITHUB_OUTPUT" # å°†ä¸‹è½½é“¾æ¥è®¾ç½®ä¸ºè¾“å‡º
        echo "æ£€æµ‹åˆ°ä¸Šæ¸¸æ ‡ç­¾: '$tag'" # æ‰“å°å¸¦å¼•å·çš„tagï¼Œæ–¹ä¾¿è°ƒè¯•ç©ºæ ¼

    - name: æ£€æŸ¥æ­¤ç‰ˆæœ¬æ˜¯å¦å·²å‘å¸ƒ # æ–°å¢æ­¥éª¤ï¼šæ£€æŸ¥å½“å‰ä»“åº“æ˜¯å¦å·²å­˜åœ¨ä¸ä¸Šæ¸¸æœ€æ–° release ç›¸åŒçš„ Git Tag
      id: check_tag
      run: |
        UPSTREAM_TAG="${{ steps.get_release.outputs.tag }}"
        echo "æ­£åœ¨æ£€æŸ¥å½“å‰ä»“åº“æ˜¯å¦å·²å­˜åœ¨ Git Tag: '$UPSTREAM_TAG'"
        # ä½¿ç”¨ git ls-remote æ£€æŸ¥è¿œç¨‹ä»“åº“ï¼ˆoriginï¼‰ä¸­æ˜¯å¦å­˜åœ¨è¯¥æ ‡ç­¾
        # grep -q ç”¨äºé™é»˜è¾“å‡ºï¼Œåªè¿”å›é€€å‡ºçŠ¶æ€ç 
        if git ls-remote --tags origin | grep -q "refs/tags/$UPSTREAM_TAG$"; then
          echo "æ£€æµ‹åˆ°æ ‡ç­¾ '$UPSTREAM_TAG' å·²å­˜åœ¨äºå½“å‰ä»“åº“ï¼Œæ­¤ç‰ˆæœ¬å·²å‘å¸ƒè¿‡ã€‚"
          echo "exists=true" >> "$GITHUB_OUTPUT"
        else
          echo "æ ‡ç­¾ '$UPSTREAM_TAG' ä¸å­˜åœ¨äºå½“å‰ä»“åº“ï¼Œå°†ç»§ç»­æ„å»ºæ–°ç‰ˆæœ¬ã€‚"
          echo "exists=false" >> "$GITHUB_OUTPUT"
        fi

    - name: æç¤ºï¼šæ­¤ç‰ˆæœ¬å·²å‘å¸ƒï¼Œå°†è·³è¿‡åç»­æ„å»ºæ­¥éª¤ # ä¿®æ”¹æ­¤æ­¥éª¤åç§°ï¼Œä½¿å…¶æ›´æ˜ç¡®
      if: steps.check_tag.outputs.exists == 'true' # åªæœ‰å½“å·²å‘å¸ƒæ—¶æ‰æ‰§è¡Œæ­¤æç¤º
      run: |
        echo "æ£€æµ‹åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬å·²åœ¨å½“å‰ä»“åº“å‘å¸ƒè¿‡ï¼Œæ— éœ€é‡å¤æ„å»ºå’Œæ¨é€ã€‚åç»­æ„å»ºæ­¥éª¤å°†è¢«è·³è¿‡ã€‚"
        # æ³¨æ„ï¼šæ­¤å¤„ä¸å†ä½¿ç”¨ exit 0 æ¥ç»ˆæ­¢æ•´ä¸ª Jobï¼Œè€Œæ˜¯é€šè¿‡åç»­æ­¥éª¤çš„ if æ¡ä»¶æ¥æ§åˆ¶è·³è¿‡ã€‚

    # ä»¥ä¸‹æ‰€æœ‰æ­¥éª¤éƒ½æ·»åŠ äº† if æ¡ä»¶ï¼Œåªæœ‰åœ¨ç‰ˆæœ¬æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
    - name: ä»æ ‡ç­¾ä¸­æå– n8n ç‰ˆæœ¬å· # æ­¥éª¤3: ä»ä¸Šæ¸¸Gitæ ‡ç­¾ä¸­æå–çº¯ç²¹çš„n8nç‰ˆæœ¬å·
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      id: get_n8n_version
      run: |
        TAG_REF="${{ steps.get_release.outputs.tag }}"
        # æå–åå†æ¬¡ä½¿ç”¨ xargs ç¡®ä¿å»é™¤æ‰€æœ‰å‰å¯¼å’Œå°¾éƒ¨ç©ºæ ¼
        N8N_VERSION=$(echo "${TAG_REF#n8n@}" | xargs) # æå–å‡º '1.115.3'
        echo "n8n_version=$N8N_VERSION" >> "$GITHUB_OUTPUT" # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºè¾“å‡º
        echo "æå–åˆ°çš„ n8n ç‰ˆæœ¬å·: '$N8N_VERSION'" # æ‰“å°å¸¦å¼•å·çš„ç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿è°ƒè¯•ç©ºæ ¼

    - name: è°ƒè¯• Docker Hub ç”¨æˆ·å # æ­¥éª¤4: æ£€æŸ¥ DOCKERHUB_USERNAME æ˜¯å¦æœ‰ç©ºæ ¼ï¼Œå¹¶æ¸…ç†
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        DOCKERHUB_USERNAME_VAL="${{ secrets.DOCKERHUB_USERNAME }}"
        echo "--- è°ƒè¯• Docker Hub ç”¨æˆ·å ---"
        echo "ç”¨æˆ·å (å¸¦å¼•å·): '$DOCKERHUB_USERNAME_VAL'"
        echo "ç”¨æˆ·åé•¿åº¦: ${#DOCKERHUB_USERNAME_VAL}"
        echo "------------------------------------"
        # å¢åŠ ä¸€ä¸ªé˜²å¾¡æ€§å¤„ç†ï¼Œç¡®ä¿ DOCKERHUB_USERNAME ä¸åŒ…å«ç©ºæ ¼ï¼Œå¹¶è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
        CLEAN_DOCKERHUB_USERNAME=$(echo "$DOCKERHUB_USERNAME_VAL" | xargs)
        echo "æ¸…ç†åçš„ç”¨æˆ·å (å¸¦å¼•å·): '$CLEAN_DOCKERHUB_USERNAME'"
        echo "æ¸…ç†åçš„ç”¨æˆ·åé•¿åº¦: ${#CLEAN_DOCKERHUB_USERNAME}"
        echo "DOCKERHUB_USERNAME=$CLEAN_DOCKERHUB_USERNAME" >> "$GITHUB_ENV" # å°†æ¸…ç†åçš„ç”¨æˆ·åè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨

    - name: ä¸‹è½½ä¸Šæ¸¸å‘å¸ƒæ–‡ä»¶ # æ­¥éª¤5: ä¸‹è½½ä¸Šæ¸¸çš„ editor-ui dist æ–‡ä»¶
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        mkdir -p src-dist
        curl -L "${{ steps.get_release.outputs.asset_url }}" -o src-dist/editor-ui.tar.gz
        echo "å·²ä¸‹è½½ ${{ steps.get_release.outputs.asset_url }}"

    - name: è§£å‹ dist æ–‡ä»¶ # æ­¥éª¤6: è§£å‹ä¸‹è½½çš„ tar.gz æ–‡ä»¶
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        tar -xzvf src-dist/editor-ui.tar.gz -C src-dist
        echo "å·²è§£å‹ dist æ–‡ä»¶åˆ° src-dist/dist"

    - name: ç”Ÿæˆ Dockerfile (å¤šé˜¶æ®µæ„å»º) # æ­¥éª¤7: åŠ¨æ€ç”Ÿæˆ Dockerfileï¼Œç°åœ¨ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        N8N_VERSION=${{ steps.get_n8n_version.outputs.n8n_version }} # ä½¿ç”¨æå–å‡ºçš„çº¯ç²¹ç‰ˆæœ¬å·
        echo "æ­£åœ¨ä¸º n8n ç‰ˆæœ¬: $N8N_VERSION ç”Ÿæˆå¤šé˜¶æ®µ Dockerfile"
        cat <<EOF > Dockerfile
        # --- é˜¶æ®µ 1: ui_holder (ç”¨äºä»æ„å»ºä¸Šä¸‹æ–‡å¤åˆ¶ dist æ–‡ä»¶) ---
        # è¿™ä¸€é˜¶æ®µä½¿ç”¨ä¸€ä¸ªè½»é‡çº§çš„åŸºç¡€é•œåƒï¼Œåªä¸ºäº†â€œæŒæœ‰â€æˆ‘ä»¬å·²ä¸‹è½½å’Œè§£å‹çš„ dist æ–‡ä»¶ã€‚
        # è¿™æ ·åšå¯ä»¥ç¡®ä¿æœ€ç»ˆé•œåƒåªåŒ…å«è¿™äº›æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ•´ä¸ª src-dist ç›®å½•çš„ä¸´æ—¶å†…å®¹ã€‚
        FROM alpine:latest as ui_holder
        WORKDIR /app
        # å°† GitHub Actions Runner ä¸Šå·²å­˜åœ¨çš„ src-dist/dist ç›®å½•å¤åˆ¶åˆ°è¿™ä¸€é˜¶æ®µçš„é•œåƒä¸­
        COPY src-dist/dist /app/dist

        # --- é˜¶æ®µ 2: Final n8n Image (æœ€ç»ˆé•œåƒ) ---
        FROM n8nio/n8n:$N8N_VERSION
        USER root

        RUN apk update \\
            && apk add --no-cache ffmpeg \\
            && rm -rf /var/cache/apk/*

        USER node

        # ä» ui_holder é˜¶æ®µå¤åˆ¶çº¯å‡€çš„ dist æ–‡ä»¶åˆ° n8n çš„ editor-ui ç›®å½•
        COPY --from=ui_holder /app/dist /usr/local/lib/node_modules/n8n/node_modules/n8n-editor-ui/dist
        EOF
        cat Dockerfile # æ‰“å°ç”Ÿæˆçš„ Dockerfile å†…å®¹ä»¥ä¾›è°ƒè¯•

    - name: è®¾ç½® Docker Buildx # æ­¥éª¤8: è®¾ç½®Docker Buildxï¼Œç”¨äºæ›´é«˜æ•ˆå’Œå®‰å…¨çš„æ„å»º
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ° Docker Hub # æ­¥éª¤9: ç™»å½•åˆ°Docker Hub
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: è°ƒè¯•æœ€ç»ˆé•œåƒæ ‡ç­¾ # æ­¥éª¤10: æ‰“å°æœ€ç»ˆçš„æ ‡ç­¾å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿è°ƒè¯•
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        # ä½¿ç”¨é€šè¿‡ $GITHUB_ENV è®¾ç½®çš„æ¸…ç†åçš„ DOCKERHUB_USERNAME
        echo "--- è°ƒè¯•æœ€ç»ˆé•œåƒæ ‡ç­¾ ---"
        echo "ç‰ˆæœ¬æ ‡ç­¾: '${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ steps.get_n8n_version.outputs.n8n_version }}'"
        echo "æœ€æ–°æ ‡ç­¾: '${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:latest'"
        echo "----------------------------------"

    - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ # æ­¥éª¤11: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ (åŒæ—¶æ‰“ä¸Šç‰ˆæœ¬å·å’Œlatestæ ‡ç­¾)
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      uses: docker/build-push-action@v5 # æ¨èä½¿ç”¨æ­¤å®˜æ–¹actionï¼Œä¸€æ­¥å®Œæˆæ„å»ºå’Œæ¨é€
      with:
        context: . # Dockerfile æ‰€åœ¨çš„ä¸Šä¸‹æ–‡è·¯å¾„
        push: true # å¯ç”¨æ¨é€
        # å®šä¹‰è¦æ¨é€çš„æ ‡ç­¾ï¼Œæ¯è¡Œä¸€ä¸ª
        tags: |
          ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:${{ steps.get_n8n_version.outputs.n8n_version }}
          ${{ env.DOCKERHUB_USERNAME }}/n8n-chinese:latest
        cache-from: type=gha # å¯ç”¨GitHub Actionsç¼“å­˜
        cache-to: type=gha,mode=max # å°†æ„å»ºç¼“å­˜å†™å…¥GitHub Actions

    - name: æ›´æ–° README æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å· # æ­¥éª¤12: æ›´æ–°READMEä¸­çš„ç‰ˆæœ¬æ ‡ç­¾
      if: steps.check_tag.outputs.exists == 'false' # åªæœ‰åœ¨æœªå‘å¸ƒæ—¶æ‰æ‰§è¡Œ
      run: |
        NEW_VERSION="${{ steps.get_n8n_version.outputs.n8n_version }}"
        DOCKER_USER="${{ env.DOCKERHUB_USERNAME }}" # è·å–æ¸…ç†åçš„ Docker Hub ç”¨æˆ·å
        echo "æ­£åœ¨æ›´æ–° README.md ç‰ˆæœ¬è‡³: $NEW_VERSION (Docker ç”¨æˆ·: $DOCKER_USER)"

        # æ›´æ–° README.md ä¸­çš„ç‰ˆæœ¬æ ‡ç­¾
        # åŠ¨æ€æ›¿æ¢ Docker ç”¨æˆ·åå’Œç‰ˆæœ¬å·
        # æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ sed å‘½ä»¤æ—¶ï¼Œå¦‚æœ DOCKER_USER åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œå¯èƒ½ä¼šéœ€è¦é¢å¤–çš„è½¬ä¹‰ã€‚
        # å‡è®¾ DOCKER_USER æ˜¯æ ‡å‡†çš„ Docker Hub ç”¨æˆ·åï¼Œä¸åŒ…å« sed çš„ç‰¹æ®Šå­—ç¬¦ã€‚
        sed -i "s|${DOCKER_USER}/n8n-chinese:[0-9]\+\.[0-9]\+\.[0-9]\+|${DOCKER_USER}/n8n-chinese:$NEW_VERSION|g" README.md

        # æ˜¾ç¤ºæ›´æ–°å†…å®¹
        echo "æ›´æ–°åçš„ README.md å†…å®¹ç‰‡æ®µ:"
        grep -n "${DOCKER_USER}/n8n-chinese:" README.md || true

        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # æäº¤æ›´æ–°
        git add README.md
        if git diff --staged --quiet; then
          echo "README.md æ²¡æœ‰å˜åŒ–ã€‚"
        else
          echo "ğŸ¤– è‡ªåŠ¨æ›´æ–° README ç‰ˆæœ¬æ ‡ç­¾è‡³ ${NEW_VERSION}" > commit_message.txt
          echo "" >> commit_message.txt
          echo "- æ›´æ–°æ‰€æœ‰ ${DOCKER_USER}/n8n-chinese ç‰ˆæœ¬æ ‡ç­¾å¼•ç”¨" >> commit_message.txt
          echo "- ç‰ˆæœ¬å·: ${NEW_VERSION}" >> commit_message.txt
          echo "- è‡ªåŠ¨æ„å»ºæµç¨‹æ›´æ–°" >> commit_message.txt
          echo "" >> commit_message.txt
          echo "ğŸ¤– ç”± GitHub Actions ç”Ÿæˆ" >> commit_message.txt
          echo "" >> commit_message.txt
          echo "Co-Authored-By: GitHub Action <action@github.com>" >> commit_message.txt

          git commit -F commit_message.txt
          rm commit_message.txt
          # æ¨é€æ–°çš„ Git Tag åˆ°å½“å‰ä»“åº“ï¼Œä»¥æ ‡è®°æ­¤ç‰ˆæœ¬å·²å¤„ç†
          git tag "${{ steps.get_release.outputs.tag }}" # ä½¿ç”¨ä¸Šæ¸¸çš„ tag ä½œä¸ºå½“å‰ä»“åº“çš„ tag
          git push origin "${{ steps.get_release.outputs.tag }}" # æ¨é€æ–°åˆ›å»ºçš„ Git Tag
          git push # æ¨é€ README.md çš„æ›´æ–°
        fi
